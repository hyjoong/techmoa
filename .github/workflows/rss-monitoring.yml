name: RSS Feed Monitoring

on:
  schedule:
    - cron: "0 6 * * *" # í•œêµ­ ì‹œê°„ ì˜¤ì „ 10ì‹œ
    - cron: "0 19 * * *" # í•œêµ­ ì‹œê°„ ì˜¤í›„ 7ì‹œ
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: read
  issues: write

jobs:
  monitor-rss:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies
        run: pnpm install

      - name: Run RSS validation
        run: pnpm run validate-rss
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

      # - name: Create issue for failed feeds
      #   if: failure()
      #   uses: actions/github-script@v7
      #   with:
      #     script: |
      #       const fs = require('fs');
      #       let results = [];

      #       try {
      #         const data = fs.readFileSync('rss-validation-results.json', 'utf8');
      #         results = JSON.parse(data);
      #       } catch (error) {
      #         console.log('ê²°ê³¼ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      #       }

      #       const invalidFeeds = results.filter(r => !r.valid);

      #       if (invalidFeeds.length > 0) {
      #         let issueBody = `## ğŸ” RSS í”¼ë“œ ëª¨ë‹ˆí„°ë§ ê²°ê³¼\n\n`;
      #         issueBody += `âš ï¸ **ë¬¸ì œê°€ ë°œê²¬ëœ RSS í”¼ë“œ**: ${invalidFeeds.length}ê°œ\n\n`;
      #         issueBody += `### ìœ íš¨í•˜ì§€ ì•Šì€ í”¼ë“œ ëª©ë¡:\n`;
      #
      #         invalidFeeds.forEach(feed => {
      #           issueBody += `- \`${feed.url}\`: ${feed.error}\n`;
      #         });
      #
      #         issueBody += `\n### ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­:\n`;
      #         issueBody += `1. RSS URLì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸\n`;
      #         issueBody += `2. í•´ë‹¹ ë¸”ë¡œê·¸ ì‚¬ì´íŠ¸ê°€ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸\n`;
      #         issueBody += `3. í•„ìš”ì‹œ RSS í”¼ë“œ URL ì—…ë°ì´íŠ¸\n`;
      #         issueBody += `4. ë¬¸ì œê°€ ì§€ì†ë˜ë©´ í•´ë‹¹ í”¼ë“œ ì œê±° ê³ ë ¤\n\n`;
      #         issueBody += `---\n`;
      #         issueBody += `*ì´ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`;

      #         // ê¸°ì¡´ ì´ìŠˆê°€ ìˆëŠ”ì§€ í™•ì¸
      #         const { data: existingIssues } = await github.rest.issues.listForRepo({
      #           owner: context.repo.owner,
      #           repo: context.repo.repo,
      #           state: 'open',
      #           labels: ['rss-monitoring']
      #         });

      #         const hasRssIssue = existingIssues.some(issue =>
      #           issue.title.includes('RSS í”¼ë“œ ëª¨ë‹ˆí„°ë§') &&
      #           issue.created_at > new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()
      #         );

      #         if (!hasRssIssue) {
      #           await github.rest.issues.create({
      #             owner: context.repo.owner,
      #             repo: context.repo.repo,
      #             title: 'ğŸ” RSS í”¼ë“œ ëª¨ë‹ˆí„°ë§ - ë¬¸ì œ ë°œê²¬',
      #             body: issueBody,
      #             labels: ['rss-monitoring', 'automated']
      #           });
      #         }
      #       }

      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rss-monitoring-results
          path: rss-validation-results.json
          retention-days: 30
